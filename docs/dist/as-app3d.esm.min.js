import THREE from '../dist/three.wrapper.js';import '../dist/OrbitControls.wrapper.js';let util={typeOf:e=>({}.toString.call(e).match(/\s(\w+)/)[1].toLowerCase()),isOneOfTypes:(e,t)=>t.includes(util.typeOf(e)),isUintArray:e=>/^uint.*array$/.test(util.typeOf(e)),isIntArray:e=>/^int.*array$/.test(util.typeOf(e)),isFloatArray:e=>/^float.*array$/.test(util.typeOf(e)),isImage:e=>util.typeOf(e)==='image',isImageable:e=>util.isOneOfTypes(e,['image','htmlimageelement','htmlcanvaselement']),isTypedArray:e=>util.typeOf(e.buffer)==='arraybuffer',isInteger:Number.isInteger||(e=>Math.floor(e)===e),isString:e=>util.typeOf(e)==='string',isObject:e=>util.typeOf(e)==='object',typeName:e=>e.constructor.name,isLittleEndian(){let e=new Uint32Array([16909060]);return new Uint8ClampedArray(e.buffer)[0]===4},inNode:()=>typeof window==='undefined'&&typeof global!=='undefined',inBrowser:()=>!util.inNode(),globalObject:()=>util.inNode()?global:window,identity:e=>e,noop:()=>{},propFcn:e=>t=>t[e],convertArray(e,t){let n=e.constructor;if(n===t)return e;return t.from(e)},arrayToBuffer(e,t = Float64Array){e.constructor===Array&&(e=new t(e));return new Uint8Array(e.buffer)},bufferToArray(e,t,n = Float64Array){t===Array&&(t=n);return t===Array?Array.from(new n(e.buffer)):new t(e.buffer)},bufferToBase64(e){let t=Array.prototype.map.call(e,e=>String.fromCharCode(e)).join('');return btoa(t)},base64ToBuffer(e){let t=atob(e),n=new Uint8Array(t.length);Array.prototype.forEach.call(t,(e,t)=>{n[t]=e.charCodeAt(0)});return n},randomSeedSin(e = Math.PI/4){return()=>{let t=Math.sin(e++)*1e4;return t-Math.floor(t)}},randomSeedParkMiller(e = 123456){e%=2147483647;return()=>{e=e*16807%2147483647;return(e-1)/2147483646}},randomSeed(e,t = !0){Math.random=t?this.randomSeedParkMiller(e):this.randomSeedSin(e)},logOnce(e){this.logOnceMsgSet||(this.logOnceMsgSet=new Set);this.logOnceMsgSet.has(e)||(console.log(e),this.logOnceMsgSet.add(e))},warn(e){this.logOnce('Warning: '+e)},print(e,t = null){this.isObject(e)&&(e=JSON.stringify(e));!t&&this.inBrowser()&&(t=document.body);t?(t.style.fontFamily='monospace',t.innerHTML+=e+'<br />'):console.log(e)},timeit(e,t = 1e5,n = 'test'){console.time(n);for(let n=0;n<t;n++)e(n);console.timeEnd(n)},fps(){let e=performance.now(),t=0;return function n(){t++;let r=performance.now()-e,o=parseFloat((t/(r/1e3)).toFixed(2));Object.assign(n,{fps:o,ms:r,steps:t})}},pps(e,t = ''){t&&console.log(t);let n=1,r='';while(e){if(typeof e==='function')r=e.constructor.toString();else{let t=Object.keys(e);r=t.length>0?`[${t.join(', ')}]`:`[${e.constructor.name}]`}console.log(`[${n++}]: ${r}`);e=Object.getPrototypeOf(e)}},arraysToString:e=>e.map(e=>`[${e}]`).join(','),toWindow(e){Object.assign(this.globalObject(),e);console.log('toWindow:',Object.keys(e).join(', '))},objectToString(e){return JSON.stringify(e,null,'  ').replace(/ {2}"/g,'  ').replace(/": /g,': ')},objectToString1(e){return JSON.stringify(e).replace(/{"/g,'{').replace(/,"/g,',').replace(/":/g,':')},parseQueryString(){let e={},t=document.location.search.substring(1);t.split('&').forEach(t=>{let n=t.split('=');e[n[0]]=n.length===1?!0:n[1]});return e},setScript(e,t = {}){let n=document.createElement('script');n.src=e;Object.assign(n,t);document.querySelector('head').appendChild(n)},getEventXY(e,t){let n=e.getBoundingClientRect();return[t.clientX-n.left,t.clientY-n.top]},randomInt:e=>Math.floor(Math.random()*e),randomInt2:(e,t)=>e+Math.floor(Math.random()*(t-e)),randomFloat:e=>Math.random()*e,randomFloat2:(e,t)=>e+Math.random()*(t-e),randomCentered:e=>util.randomFloat2(-e/2,e/2),randomNormal(e = 0,t = 1){let[n,r]=[1-Math.random(),Math.random()],o=Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*r);return o*t+e},isPowerOf2:e=>(e&e-1)===0,nextPowerOf2:e=>Math.pow(2,Math.ceil(Math.log2(e))),mod:(e,t)=>(e%t+t)%t,wrap:(e,t,n)=>t+util.mod(e-t,n-t),clamp(e,t,n){if(e<t)return t;if(e>n)return n;return e},between:(e,t,n)=>t<=e&&e<=n,lerp:(e,t,n)=>e<=t?e+(t-e)*n:e-(e-t)*n,lerpScale:(e,t,n)=>(e-t)/(n-t),radians:e=>e*Math.PI/180,degrees:e=>e*180/Math.PI,heading(e){let t=this.degrees(e);return this.mod(90-t,360)},angle(e){let t=this.mod(360-e,360);return this.radians(t)},subtractRadians(e,t){let n=this.mod(e-t,2*Math.PI);n>Math.PI&&(n-=2*Math.PI);return n},subtractHeadings(e,t){let n=this.mod(e-t,360);n>180&&(n-=360);return n},radiansToward:(e,t,n,r)=>Math.atan2(r-t,n-e),headingToward(e,t,n,r){return this.heading(this.radiansToward(e,t,n,r))},distance:(e,t,n,r)=>Math.sqrt(util.sqDistance(e,t,n,r)),sqDistance:(e,t,n,r)=>(e-n)*(e-n)+(t-r)*(t-r),inCone(e,t,n,r,o,i,a){if(this.sqDistance(i,a,e,t)>n*n)return!1;let s=this.radiansToward(i,a,e,t);return r/2>=Math.abs(this.subtractRadians(o,s))},repeat(e,t,n = []){for(let r=0;r<e;r++)t(r,n);return n},step(e,t,n){for(let r=0;r<e;r+=t)n(r)},range(e){return this.repeat(e,(e,t)=>{t[e]=e})},arrayMax:e=>e.reduce((e,t)=>Math.max(e,t)),arrayMin:e=>e.reduce((e,t)=>Math.min(e,t)),arraySum:e=>e.reduce((e,t)=>e+t),arraysEqual(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++){if(e[n]!==t[n])return!1}return!0},removeArrayItem(e,t){let n=e.indexOf(t);n!==-1?e.splice(n,1):this.warn(`removeArrayItem: ${t} not in array`);return e},forEach(e,t){if(e.slice){for(let n=0,r=e.length;n<r;n++)t(e[n],n,e)}else Object.keys(e).forEach(n=>t(e[n],n,e));return e},clone(e){return e.slice(0)},concatArrays(e,t){let n=e.constructor;if(n===Array){return e.concat(this.convertArray(t,Array))}let r=new n(e.length+t.length);r.set(e);r.set(t,e.length);return r},objectsEqual:(e,t)=>JSON.stringify(e)===JSON.stringify(t),histogram(e,t = 1,n = Math.floor(this.arrayMin(e))){let r=[],[o,i]=[Number.MAX_VALUE,Number.MIN_VALUE],[a,s]=[Number.MAX_VALUE,Number.MIN_VALUE];for(let u of e){let e=Math.floor(u/t)-n;r[e]=r[e]===void 0?1:r[e]+1;o=Math.min(o,e);i=Math.max(i,e);a=Math.min(a,u);s=Math.max(s,u)}for(let e in r)r[e]===void 0&&(r[e]=0);let u=i-o+1;return{bins:u,minBin:o,maxBin:i,minVal:a,maxVal:s,hist:r}},oneOf:e=>e[util.randomInt(e.length)],otherOneOf(e,t){if(e.length<2)throw Error('util.otherOneOf: array.length < 2');do{var n=this.oneOf(e)}while(t===n);return n},oneKeyOf:e=>util.oneOf(Object.keys(e)),oneValOf:e=>e[util.oneKeyOf(e)],sortNums(e,t = !0){return e.sort((e,n)=>t?e-n:n-e)},sortObjs(e,t,n = !0){typeof t==='string'&&(t=this.propFcn(t));let r=(e,n)=>t(e)-t(n);return e.sort((e,t)=>n?r(e,t):-r(e,t))},shuffle(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[n];e[n]=r}return e},uniq(e,t = this.identity){this.isString(t)&&(t=this.propFcn(t));return e.filter((e,n,r)=>n===0||t(e)!==t(r[n-1]))},aRamp(e,t,n){if(n<=1)throw Error('aRamp: numItems must be > 1');let r=[];for(let o=0;o<n;o++)r.push(e+(t-e)*(o/(n-1)));return r},aIntRamp(e,t,n = Math.abs(t-e)+1){return this.aRamp(e,t,n).map(e=>Math.round(e))},normalize(e,t = 0,n = 1){let[r,o]=[this.arrayMin(e),this.arrayMax(e)],i=1/(o-r);return e.map(e=>this.lerp(t,n,i*(e-r)))},normalize8(e){return new Uint8ClampedArray(this.normalize(e,-.5,255.5))},normalizeInt(e,t,n){return this.normalize(e,t,n).map(e=>Math.round(e))},imagePromise(e){return new Promise((t,n)=>{let r=new Image;r.crossOrigin='Anonymous';r.onload=()=>t(r);r.onerror=()=>n(Error(`Could not load image ${e}`));r.src=e})},xhrPromise(e,t = 'text',n = 'GET'){return new Promise((r,o)=>{let i=new XMLHttpRequest;i.open(n,e);i.responseType=t;i.onload=()=>r(i.response);i.onerror=()=>o(Error(`Could not load ${e}: ${i.status}`));i.send()})},timeoutPromise(e = 1e3){return new Promise(t=>{setTimeout(t,e)})},async timeoutLoop(e,t = -1,n = 0){let r=0;while(r++!==t)e(r),await this.timeoutPromise(n)},yieldLoop(e,t = -1){let n=0;function*r(){while(n++!==t)yield e(n)}let o=r();while(!o.next().done);},rafPromise(){return new Promise(e=>requestAnimationFrame(e))},async rafLoop(e,t = -1){let n=0;while(n++!==t)e(n),await this.rafPromise()},waitPromise(e,t = 10){return new Promise(n=>{function r(){if(e())return n();else setTimeout(r,t)}r()})},createCanvas(e,t){let n=document.createElement('canvas');Object.assign(n,{width:e,height:t});return n},createCtx(e,t){let n=this.createCanvas(e,t);return n.getContext('2d')},cloneCtx(e){let t=this.createCtx(e.canvas.width,e.canvas.height);t.drawImage(e.canvas,0,0);return t},resizeCtx(e,t,n){let r=this.cloneCtx(e);e.canvas.width=t;e.canvas.height=n;e.drawImage(r.canvas,0,0)},setIdentity(e){e.save();e.setTransform(1,0,0,1,0,0)},setTextParams(e,t,n = 'center',r = 'middle'){Object.assign(e,{font:t,textAlign:n,textBaseline:r})},ctxImageData(e){return e.getImageData(0,0,e.canvas.width,e.canvas.height)},fillCtxWithImage(e,t){this.setIdentity(e);e.drawImage(t,0,0,e.canvas.width,e.canvas.height);e.restore()}};class AgentArray extends Array{static fromArray(e){Object.setPrototypeOf(e,AgentArray.prototype);return e}toArray(){Object.setPrototypeOf(this,Array.prototype);return this}isEmpty(){return this.length===0}first(){return this[0]}last(){return this[this.length-1]}props(e){let t=new AgentArray(this.length);for(let n=0;n<this.length;n++)t[n]=this[n][e];return t}values(e){let t=new AgentArray(this.length);for(let n=0;n<this.length;n++)t[n]=e(this[n]);return t}uniq(e = util.identity){util.isString(e)&&(e=t=>t[e]);return this.filter((t,n,r)=>n===0||e(t)!==e(r[n-1]))}each(e){for(let t=0,n=this.length;t<n;t++)e(this[t],t,this)}ask(e){let t=this.length;for(let n=0;n<Math.min(t,this.length);n++){e(this[n],n,this);if(t!=this.length){let e=this.name||this.constructor.name,n=this.length<t?'decreasing':'increasing';util.warn(`AgentArray.ask array mutation: ${e}: ${n}`)}}}count(e){return this.reduce((t,n)=>t+(e(n)?1:0),0)}sum(e){return this.reduce((t,n)=>t+(e?n[e]:n),0)}avg(e){return this.sum(e)/this.length}min(e){return this.reduce((t,n)=>Math.min(t,e?n[e]:n),1/0)}max(e){return this.reduce((t,n)=>Math.max(t,e?n[e]:n),-1/0)}histogram(e,t = 10,n = this.min(e),r = this.max(e)){let o=(r-n)/t,i=new AgentArray(t);i.fill(0);this.ask(a=>{let s=e?a[e]:a;if(s<n||s>r)util.warn(`histogram bounds error: ${s}: ${n}-${r}`);else{let e=Math.floor((s-n)/o);e===t&&e--;i[e]++}});i.parameters={key:e,bins:t,min:n,max:r,binSize:o,arraySize:this.length};return i}clone(e = 0,t = this.length){return this.slice(e,t)}shuffle(){return util.shuffle(this)}sortBy(e,t = !0){util.sortObjs(this,e,t);return this}remove(e,t){let n=this.agentIndex(e,t);n!==-1?this.splice(n,1):util.warn(`remove: ${e} not in AgentArray`);return this}insert(e,t){let n=this.sortedIndex(e,t);if(this[n]===e)throw Error('insert: item already in AgentArray');this.splice(n,0,e)}sortedIndex(e,t = util.identity){util.isString(t)&&(t=util.propFcn(t));let n=t(e),r=0,o=this.length;while(r<o){let e=r+o>>>1;t(this[e])<n?(r=e+1):(o=e)}return r}agentIndex(e,t){if(!t)return this.indexOf(e);let n=this.sortedIndex(e,t);return this[n]===e?n:-1}contains(e,t){return this.agentIndex(e,t)>=0}oneOf(){return util.oneOf(this)}otherOneOf(e){return util.otherOneOf(this,e)}otherNOf(e,t){if(this.length<e)throw Error('AgentArray: otherNOf: length < N');return this.clone().remove(t).shuffle().slice(0,e)}minOrMaxOf(e,t,n = !1){if(this.isEmpty())throw Error('min/max OneOf: empty array');typeof t==='string'&&(t=util.propFcn(t));let r=null,o=e?1/0:-1/0;for(let n=0;n<this.length;n++){let i=this[n],a=t(i);(e&&a<o||!e&&a>o)&&([r,o]=[i,a])}return n?[r,o]:r}minOneOf(e){return this.minOrMaxOf(!0,e)}maxOneOf(e){return this.minOrMaxOf(!1,e)}minValOf(e){return this.minOrMaxOf(!0,e,!0)}maxValOf(e){return this.minOrMaxOf(!1,e,!0)}nOf(e){if(e>this.length)throw Error('nOf: n larger than AgentArray');if(e===this.length)return this;let t=new AgentArray;while(t.length<e){let e=this.oneOf();(e in t)||t.push(e)}return t}minOrMaxNOf(e,t,n){if(t>this.length){throw Error('min/max nOf: n larger than AgentArray')}let r=this.clone().sortBy(n);return e?r.clone(0,t):r.clone(r.length-t)}minNOf(e,t){return this.minOrMaxNOf(!0,e,t)}maxNOf(e,t){return this.minOrMaxNOf(!1,e,t)}inRect(e,t,n = t,r = !1){let o=new AgentArray,i=e.x-t,a=e.x+t,s=e.y-n,u=e.y+n;this.ask(t=>{i<=t.x&&t.x<=a&&s<=t.y&&t.y<=u&&((r||e!==t)&&o.push(t))});return o}inRadius(e,t,n = !1){let r=new AgentArray,o=t*t,i=util.sqDistance;this.ask(t=>{i(e.x,e.y,t.x,t.y)<=o&&((n||e!==t)&&r.push(t))});return r}inCone(e,t,n,r,o = !1){let i=new AgentArray;this.ask(a=>{util.inCone(a.x,a.y,t,n,r,e.x,e.y)&&((o||e!==a)&&i.push(a))});return i}}class AgentSet extends AgentArray{static get[Symbol.species](){return AgentArray}constructor(e,t,n,r = null){super();r=r||this;Object.assign(this,{model:e,name:n,baseSet:r,AgentClass:t});this.isBaseSet()?(this.breeds={},this.ID=0):(Object.setPrototypeOf(this,Object.getPrototypeOf(r)),this.baseSet.breeds[n]=this);this.ownVariables=[];this.agentProto=new t(this);this.protoMixin(this.agentProto,t)}protoMixin(e,t){Object.assign(e,{agentSet:this,model:this.model});e[this.baseSet.name]=this.baseSet;t.prototype.setBreed||(Object.assign(t.prototype,{setBreed(e){e.setBreed(this)},getBreed(){return this.agentSet},isBreed(e){return this.agentSet===e}}),Object.defineProperty(t.prototype,'breed',{get:function(){return this.agentSet}}))}newBreed(e){return new AgentSet(this.model,this.AgentClass,e,this)}isBreedSet(){return this.baseSet!==this}isBaseSet(){return this.baseSet===this}withBreed(e){return this.filter(t=>t.agentSet===e)}create(){console.log(`AgentSet: Abstract method called: ${this}`)}addAgent(e){e=e||Object.create(this.agentProto);this.isBreedSet()?this.baseSet.addAgent(e):(e.id=this.ID++);this.push(e);return e}clear(){while(!this.isEmpty())this.last().die()}removeAgent(e){this.isBreedSet()&&this.baseSet.remove(e,'id');this.remove(e,'id');return this}setDefault(e,t){this.agentProto[e]=t;return this}getDefault(e){return this.agentProto[e]}settingDefault(e){return e.id==null}own(e){for(let t of e.split(' '))this.setDefault(t,null),this.ownVariables.push(t)}setBreed(e){if(e.agentSet===this)return;e.agentSet.isBreedSet()&&e.agentSet.remove(e,'id');this.isBreedSet()&&this.insert(e,'id');let t=e.agentSet.ownVariables;for(let n of t)this.ownVariables.includes(n)||delete e[n];for(let n of this.ownVariables)t.includes(n)||(e[n]=0);return Object.setPrototypeOf(e,this.agentProto)}ask(e){if(this.length===0)return;let t=this.last().id;for(let n=0;n<this.length&&this[n].id<=t;n++)e(this[n],n,this)}askSet(e){if(this.length===0)return;this.name==='patches'&&super.ask(e);this.isBaseSet()&&this.baseSetAsk(e);this.isBreedSet()&&this.cloneAsk(e)}baseSetAsk(e){if(this.length===0)return;let t=this.last().id;for(let n=0;n<this.length&&this[n].id<=t;n++){let t=this[n].id;e(this[n],n,this);while(n<this.length&&n>=0&&this[n].id>t)n--}}cloneAsk(e){let t=this.clone();for(let n=0;n<t.length;n++){let r=t[n];r.breed==this&&r.id>0&&e(r,n,t)}}}class DataSet{static emptyDataSet(e,t,n){return new DataSet(e,t,new n(e*t))}constructor(e,t,n){if(n.length!==e*t){throw Error(`new DataSet length: ${n.length} !== ${e} * ${t}`)}Object.assign(this,{width:e,height:t,data:n})}setName(e){this.name=e;return this}getName(){return this.name?this.name:this.makeName()}makeName(){let{width:e,height:t}=this,n=util.arraySum(this.data).toFixed(2);return`${this.dataType().name}-${e}-${t}-${n}`}checkXY(e,t){if(!this.inBounds(e,t)){throw Error(`DataSet: x,y out of range: ${e}, ${t}`)}}inBounds(e,t){return util.between(e,0,this.width-1)&&util.between(t,0,this.height-1)}dataType(){return this.data.constructor}type(){return this.constructor}toIndex(e,t){return e+t*this.width}toXY(e){return[e%this.width,Math.floor(e/this.width)]}getXY(e,t){return this.data[this.toIndex(e,t)]}setXY(e,t,n){this.data[this.toIndex(e,t)]=n}sample(e,t,n = !0){this.checkXY(e,t);return n?this.nearest(e,t):this.bilinear(e,t)}nearest(e,t){return this.getXY(Math.round(e),Math.round(t))}bilinear(e,t){let n=Math.floor(e),r=Math.floor(t),o=this.toIndex(n,r),i=this.width,a=e-n,s=t-r,u=1-a,c=1-s,l=this.data[o],d=this.data[o+1]||0,f=this.data[o+i]||0,h=this.data[o+1+i]||0;return l*u*c+d*a*c+f*u*s+h*a*s}copy(){return new DataSet(this.width,this.height,util.clone(this.data))}emptyDataSet(e,t,n = this.dataType()){return DataSet.emptyDataSet(e,t,n)}emptyArray(e){let t=this.type();return new t(e)}resample(e,t,n = !0,r = Array){if(e===this.width&&t===this.height)return this.copy();let o=DataSet.emptyDataSet(e,t,r),i=(this.width-1)/(e-1),a=(this.height-1)/(t-1);for(let r=0;r<t;r++){for(let t=0;t<e;t++)o.setXY(t,r,this.sample(t*i,r*a,n))}return o}scale(e,t){let n=this.min(),r=this.max(),o=r-n,i=t-e,a=i/o,s=e-a*n;return this.map(e=>a*e+s)}subset(e,t,n,r){if(e+n>this.width||t+r>this.height){throw Error('DataSet.subSet: params out of range')}let o=this.emptyDataSet(n,r);for(let i=0;i<n;i++){for(let n=0;n<r;n++)o.setXY(i,n,this.getXY(i+e,n+t))}return o}map(e){return new DataSet(this.width,this.height,this.data.map(e))}col(e){let[t,n,r]=[this.width,this.height,this.data];if(e>=t)throw Error(`col: x out of range width: ${t} x: ${e}`);let o=this.emptyArray(n);for(let i=0;i<n;i++)o[i]=r[e+i*t];return o}row(e){let[t,n]=[this.width,this.height];if(e>=n)throw Error(`row: y out of range height: ${n} x: ${e}`);return this.data.slice(e*t,(e+1)*t)}convertType(e){this.data=util.convertArray(this.data,e)}concatEast(e){let[t,n]=[this.width,this.height],[r,o]=[e.width,e.height];if(n!==o)throw Error(`concatEast: heights not equal ${n}, ${o}`);let i=this.emptyDataSet(t+r,n);for(let e=0;e<n;e++){for(let n=0;n<t;n++)i.setXY(e,n,this.getXY(e,n))}for(let n=0;n<o;n++){for(let o=0;o<r;o++)i.setXY(n+t,o,e.getXY(n,o))}return i}concatSouth(e){let[t,n,r]=[this.width,this.height,this.data];if(t!==e.width){throw Error(`concatSouth: widths not equal ${t}, ${e.width}`)}let o=util.concatArrays(r,e.data);return new DataSet(t,n+e.height,o)}transformCoords(e,t,n,r,o,i){let a=(e-n)*(this.width-1)/o,s=(r-t)*(this.height-1)/i;return[a,s]}coordSample(e,t,n,r,o,i,a = !0){let[s,u]=this.transformCoords(e,t,n,r,o,i);return this.sample(s,u,a)}neighborhood(e,t,n = []){n.length=0;let r=e===0||e===this.width-1||t===0||t===this.height-1;for(let o=-1;o<=1;o++){for(let i=-1;i<=1;i++){let a=e+i,s=t+o;r&&(a=util.clamp(a,0,this.width-1),s=util.clamp(s,0,this.height-1));n.push(this.data[this.toIndex(a,s)])}}return n}convolve(e,t = 1,n = !1){let[r,o,i,a]=n?[1,1,this.height-1,this.width-1]:[0,0,this.height,this.width],s=this.emptyDataSet(a,i),u=s.data,c=0;for(let n=o;n<i;n++){for(let o=r;o<a;o++){let r=this.neighborhood(o,n),i=0;for(let t=0;t<e.length;t++)i+=e[t]*r[t];u[c++]=i*t}}return s}dzdx(e = 2,t = .125){return this.convolve([-1,0,1,-e,0,e,-1,0,1],t)}dzdy(e = 2,t = .125){return this.convolve([1,e,1,0,0,0,-1,-e,-1],t)}laplace8(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])}laplace4(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])}blur(e = .0625){return this.convolve([1,2,1,2,4,2,1,2,1],e)}edge(){return this.convolve([1,1,1,1,-7,1,1,1,1])}slopeAndAspect(e = 1,t = !0){let n=this.dzdx(),r=this.dzdy(),[o,i]=[[],[]],[a,s]=[n.height,n.width];for(let u=0;u<a;u++){for(let a=0;a<s;a++){let[s,c]=[n.getXY(a,u),r.getXY(a,u)];i.push(Math.atan(util.distance(0,0,s,c))/e);let l=Math.atan2(-c,-s);t&&l<0&&(l+=2*Math.PI);o.push(l)}}i=new DataSet(s,a,i);o=new DataSet(s,a,o);return{slope:i,aspect:o,dzdx:n,dzdy:r}}max(){return util.arrayMax(this.data)}min(){return util.arrayMin(this.data)}equals(e){return this.width===e.width&&this.height===e.height&&util.arraysEqual(this.data,e.data)}}class Link{static defaultVariables(){return{end0:null,end1:null,width:1}}constructor(){Object.assign(this,Link.defaultVariables())}init(e,t){this.end0=e;this.end1=t;e.links.push(this);t.links.push(this)}die(){this.agentSet.removeAgent(this);util.removeArrayItem(this.end0.links,this);util.removeArrayItem(this.end1.links,this);this.id=-1}bothEnds(){return[this.end0,this.end1]}length(){return this.end0.distance(this.end1)}otherEnd(e){if(e===this.end0)return this.end1;if(e===this.end1)return this.end0;throw Error(`Link.otherEnd: turtle not a link turtle: ${e}`)}}class Links extends AgentSet{create(e,t,n = e=>{}){Array.isArray(t)||(t=[t]);return t.map(t=>{let r=this.addAgent();r.init(e,t);n(r);return r})}}class World{static defaultOptions(e = 16,t = e){return{minX:-e,maxX:e,minY:-t,maxY:t}}constructor(e = {}){Object.assign(this,World.defaultOptions());Object.assign(this,e);this.setWorld()}setWorld(){this.numX=this.maxX-this.minX+1;this.numY=this.maxY-this.minY+1;this.width=this.numX;this.height=this.numY;this.minXcor=this.minX-.5;this.maxXcor=this.maxX+.5;this.minYcor=this.minY-.5;this.maxYcor=this.maxY+.5;this.centerX=(this.minX+this.maxX)/2;this.centerY=(this.minY+this.maxY)/2}isOnWorld(e,t){return this.minXcor<=e&&e<=this.maxXcor&&this.minYcor<=t&&t<=this.maxYcor}setCtxTransform(e,t){e.canvas.width=this.width*t;e.canvas.height=this.height*t;e.save();e.scale(t,-t);e.translate(-(this.minXcor*t),-(this.maxYcor*t))}}class Patches extends AgentSet{constructor(e,t,n){super(e,t,n);if(this.isBreedSet())return;this.populate();this.labels=[]}populate(){util.repeat(this.model.world.numX*this.model.world.numY,e=>{this.addAgent()})}setDefault(e,t){e==='color'?(this.ask(e=>{e.setColor(t)}),util.logOnce('patches.setDefault(color, value): color default not supported. Clearing to value')):super.setDefault(e,t)}setLabel(e,t){t==null?delete this.labels[e.id]:(this.labels[e.id]=t)}getLabel(e){return this.labels[e.id]}neighborsOffsets(e,t){let{minX:n,maxX:r,minY:o,maxY:i,numX:a}=this.model.world;if(e===n){if(t===o)return[-a,-a+1,1];if(t===i)return[1,a+1,a];return[-a,-a+1,1,a+1,a]}if(e===r){if(t===o)return[-a-1,-a,-1];if(t===i)return[a,a-1,-1];return[-a-1,-a,a,a-1,-1]}if(t===o)return[-a-1,-a,-a+1,1,-1];if(t===i)return[1,a+1,a,a-1,-1];return[-a-1,-a,-a+1,1,a+1,a,a-1,-1]}neighbors4Offsets(e,t){let n=this.model.world.numX;return this.neighborsOffsets(e,t).filter(e=>Math.abs(e)===1||Math.abs(e)===n)}neighbors(e){let{id:t,x:n,y:r}=e,o=this.neighborsOffsets(n,r),i=new AgentArray(o.length);o.forEach((e,n)=>{i[n]=this[e+t]});return i}neighbors4(e){let{id:t,x:n,y:r}=e,o=this.neighbors4Offsets(n,r),i=new AgentArray(o.length);o.forEach((e,n)=>{i[n]=this[e+t]});return i}randomPt(){let{minX:e,maxX:t,minY:n,maxY:r}=this.model.world;return[util.randomInt2(e,t),util.randomInt2(n,r)]}importDataSet(e,t,n = !1){if(this.isBreedSet()){util.warn('Patches: exportDataSet called with breed, using patches');this.baseSet.importDataSet(e,t,n);return}let{numX:r,numY:o}=this.model.world,i=e.resample(r,o,n);this.ask(e=>{e[t]=i.data[e.id]})}exportDataSet(e,t = Array){if(this.isBreedSet()){util.warn('Patches: exportDataSet called with breed, using patches');return this.baseSet.exportDataSet(e,t)}let{numX:n,numY:r}=this.model.world,o=this.props(e);o=util.convertArray(o,t);return new DataSet(n,r,o)}patchIndex(e,t){let{minX:n,maxY:r,numX:o}=this.model.world;return e-n+o*(r-t)}patch(e,t){if(!this.model.world.isOnWorld(e,t))return void 0;let n=e===this.model.world.maxXcor?this.model.world.maxX:Math.round(e),r=t===this.model.world.maxYcor?this.model.world.maxY:Math.round(t);return this.patchXY(n,r)}patchXY(e,t){return this[this.patchIndex(e,t)]}patchRect(e,t,n = t,r = !0){if(e.rectCache){let o=this.cacheIndex(t,n,r),i=e.rectCache[o];if(i)return i}let o=new AgentArray,{minX:i,maxX:a,minY:s,maxY:u}=this.model.world;i=Math.max(i,e.x-t);a=Math.min(a,e.x+t);s=Math.max(s,e.y-n);u=Math.min(u,e.y+n);for(let t=s;t<=u;t++){for(let n=i;n<=a;n++){let i=this.patchXY(n,t);(e!==i||r)&&o.push(i)}}return o}patchRectXY(e,t,n,r = n,o = !0){return this.patchRect(this.patch(e,t),n,r,o)}cacheIndex(e,t = e,n = !0){return(2*e+1)*(2*t+1)+(n?0:-1)}cacheRect(e,t = e,n = !0,r = !0){let o=this.cacheIndex(e,t,n);this.ask(i=>{(!i.rectCache||r)&&(i.rectCache=[]);let a=this.inRect(i,e,t,n);i.rectCache[o]=a})}inRect(e,t,n = t,r = !0){let o=this.patchRect(e,t,n,r);if(this.isBaseSet())return o;return o.withBreed(this)}inRadius(e,t,n = !0){let r=Math.ceil(t),o=this.inRect(e,r,r,n);return o.inRadius(e,t,n)}inCone(e,t,n,r,o = !0){let i=Math.ceil(t),a=this.inRect(e,i,i,o);return a.inCone(e,t,n,r,o)}patchAtAngleAndDistance(e,t,n){let{x:r,y:o}=e;r+=n*Math.cos(t);o+=n*Math.sin(t);return this.patch(r,o)}isOnEdge(e){let{x:t,y:n}=e,{minX:r,maxX:o,minY:i,maxY:a}=this.model.world;return t===r||t===o||n===i||n===a}edgePatches(){return this.filter(e=>this.isOnEdge(e))}diffuse(e,t){this.diffuseN(8,e,t)}diffuse4(e,t){this.diffuseN(4,e,t)}diffuseN(e,t,n){if(this[0]._diffuseNext===void 0){for(let e=0;e<this.length;e++)this[e]._diffuseNext=0}for(let r=0;r<this.length;r++){let o=this[r],i=o[t]*n,a=i/e,s=e===8?o.neighbors:o.neighbors4,u=s.length;o._diffuseNext+=o[t]-i+(e-u)*a;for(let e=0;e<s.length;e++)s[e]._diffuseNext+=a}for(let e=0;e<this.length;e++){let n=this[e];n[t]=n._diffuseNext;n._diffuseNext=0}}}class Patch{static defaultVariables(){return{turtles:void 0}}constructor(){Object.assign(this,Patch.defaultVariables())}get x(){return this.id%this.model.world.numX+this.model.world.minX}get y(){return this.model.world.maxY-Math.floor(this.id/this.model.world.numX)}isOnEdge(){return this.patches.isOnEdge(this)}get neighbors(){let e=this.patches.neighbors(this);Object.defineProperty(this,'neighbors',{value:e,enumerable:!0});return e}get neighbors4(){let e=this.patches.neighbors4(this);Object.defineProperty(this,'neighbors4',{value:e,enumerable:!0});return e}turtlesHere(){this.turtles==null&&(this.patches.ask(e=>{e.turtles=[]}),this.model.turtles.ask(e=>{e.patch.turtles.push(e)}));return this.turtles}breedsHere(e){let t=this.turtlesHere();return t.withBreed(e)}distanceXY(e,t){return util.distance(this.x,this.y,e,t)}distance(e){return this.distanceXY(e.x,e.y)}towards(e){return this.towardsXY(e.x,e.y)}towardsXY(e,t){return util.radiansToward(this.x,this.y,e,t)}patchAt(e,t){return this.patches.patch(this.x+e,this.y+t)}patchAtAngleAndDistance(e,t){return this.patches.patchAtAngleAndDistance(this,e,t)}sprout(e = 1,t = this.model.turtles,n = e=>{}){return t.create(e,e=>{e.setxy(this.x,this.y),n(e)})}}class Turtles extends AgentSet{create(e = 1,t = e=>{}){return util.repeat(e,(e,n)=>{let r=this.addAgent();r.theta=util.randomFloat(Math.PI*2);t(r);n.push(r)})}randomPt(){let{minXcor:e,maxXcor:t,minYcor:n,maxYcor:r}=this.model.world;return[util.randomFloat2(e,t),util.randomFloat2(n,r)]}inPatches(e){let t=new AgentArray;for(let n of e)t.push(...n.turtlesHere());this.isBreedSet()&&(t=t.filter(e=>e.agentSet===this));return t}inPatchRect(e,t,n = t,r = !1){let o=this.model.patches.inRect(e.patch,t,n,!0),i=this.inPatches(o);r||util.removeArrayItem(i,e);return i}inRadius(e,t,n = !1){let r=this.inPatchRect(e,t,t,!0);return r.inRadius(e,t,n)}inCone(e,t,n,r = !1){let o=this.inPatchRect(e,t,t,!0);return o.inCone(e,t,n,e.theta,r)}layoutCircle(e,t = [0,0],n = Math.PI/2,r = -1){let o=2*Math.PI/this.length,[i,a]=t;this.ask((t,s)=>{t.setxy(i,a),t.theta=n+r*o*s,t.forward(e)})}}class Turtle{static defaultVariables(){return{x:0,y:0,z:0,theta:0,atEdge:'clamp'}}constructor(){Object.assign(this,Turtle.defaultVariables())}die(){this.agentSet.removeAgent(this);if(this.hasOwnProperty('links')){while(this.links.length>0)this.links[0].die()}this.patch.turtles!=null&&util.removeArrayItem(this.patch.turtles,this);this.id=-1}hatch(e = 1,t = this.agentSet,n = e=>{}){return t.create(e,e=>{e.setxy(this.x,this.y);for(let n of t.ownVariables)e[n]==null&&(e[n]=this[n]);n(e)})}get links(){Object.defineProperty(this,'links',{value:new AgentArray(0),enumerable:!0});return this.links}get patch(){return this.model.patches.patch(this.x,this.y)}get heading(){return util.heading(this.theta)}set heading(e){this.theta=util.angle(e)}get direction(){return this.theta}set direction(e){this.theta=e}setxy(e,t,n = null){let r=this.patch;n!=null&&(this.z=n);this.model.world.isOnWorld(e,t)?(this.x=e,this.y=t):this.handleEdge(e,t);let o=this.patch;o.turtles!=null&&o!==r&&(util.removeArrayItem(r.turtles,this),o.turtles.push(this))}handleEdge(e,t){if(util.isString(this.atEdge)){let{minXcor:n,maxXcor:r,minYcor:o,maxYcor:i}=this.model.world;if(this.atEdge==='wrap')this.x=util.wrap(e,n,r),this.y=util.wrap(t,o,i);else if(this.atEdge==='clamp'||this.atEdge==='bounce')this.x=util.clamp(e,n,r),this.y=util.clamp(t,o,i),this.atEdge==='bounce'&&(this.x===n||this.x===r?(this.theta=Math.PI-this.theta):(this.theta=-this.theta));else{throw Error(`turtle.handleEdge: bad atEdge: ${this.atEdge}`)}}else this.atEdge(this)}moveTo(e){this.setxy(e.x,e.y)}forward(e){this.setxy(this.x+e*Math.cos(this.theta),this.y+e*Math.sin(this.theta))}rotate(e){this.theta=util.mod(this.theta+e,Math.PI*2)}right(e){this.rotate(-e)}left(e){this.rotate(e)}face(e){this.theta=this.towards(e)}faceXY(e,t){this.theta=this.towardsXY(e,t)}patchAhead(e){return this.patchAtAngleAndDistance(this.theta,e)}canMove(e){return this.patchAhead(e)!=null}patchLeftAndAhead(e,t){return this.patchAtAngleAndDistance(e+this.theta,t)}patchRightAndAhead(e,t){return this.patchAtAngleAndDistance(e-this.theta,t)}distanceXY(e,t){return util.distance(this.x,this.y,e,t)}distance(e){return util.distance(this.x,this.y,e.x,e.y)}towards(e){return this.towardsXY(e.x,e.y)}towardsXY(e,t){return util.radiansToward(this.x,this.y,e,t)}patchAt(e,t){return this.model.patches.patch(this.x+e,this.y+t)}patchAtAngleAndDistance(e,t){return this.model.patches.patchAtAngleAndDistance(this,e,t)}otherEnd(e){return e.end0===this?e.end1:e.end0}linkNeighbors(){return this.links.map(e=>this.otherEnd(e))}}class Model{static defaultWorld(e = 16,t = e){return World.defaultOptions(e,t)}constructor(e = Model.defaultWorld()){this.worldOptions=e;this.resetModel()}initAgentSet(e,t,n){let r=new t(this,n,e);this[e]=r}resetModel(){this.ticks=0;this.world=new World(this.worldOptions);this.initAgentSet('patches',Patches,Patch);this.initAgentSet('turtles',Turtles,Turtle);this.initAgentSet('links',Links,Link)}reset(){this.resetModel()}tick(){this.ticks++}setup(){}step(){}patchBreeds(e){for(let t of e.split(' '))this[t]=this.patches.newBreed(t)}turtleBreeds(e){for(let t of e.split(' '))this[t]=this.turtles.newBreed(t)}linkBreeds(e){for(let t of e.split(' '))this[t]=this.links.newBreed(t)}}class RGBDataSet extends DataSet{static scaleFromMinMax(e,t){return(t-e)/16777215}constructor(e,t = 0,n = 1,r = Float32Array){super(e.width,e.height,new r(e.width*e.height));let o=util.createCtx(e.width,e.height);util.fillCtxWithImage(o,e);let i=util.ctxImageData(o),a=this.data;for(var s=0;s<a.length;s++){let e=i.data[4*s],r=i.data[4*s+1],o=i.data[4*s+2];a[s]=t+(e*256*256+r*256+o)*n}}}function type(e){return e===null?'Null':e===void 0?'Undefined':Object.prototype.toString.call(e).slice(8,-1)}function toJSON(e,t = 0,n = !0){let r=n,o=['rectCache'],i=JSON.stringify(e,(e,t)=>{if(o.includes(e))return void 0;let n=Array.isArray(t)&&t.length>0&&Number.isInteger(t[0].id);if(n&&!r){return t.map(e=>e.id)}r=!1;return t},t);return i}function sampleObj(e){let t={model:Object.keys(e),patches:e.patches.length,patch:e.patches.oneOf(),turtles:e.turtles.length,turtle:e.turtles.oneOf(),links:e.links.length,link:e.links.oneOf()},n=toJSON(t);return JSON.parse(n)}function sampleJSON(e,t = 0){return toJSON(sampleObj(e),t)}function printToPage(e,t = document.body){type(e)==='Object'&&(e=JSON.stringify(e,null,2),e='<pre>'+e+'</pre>');t.style.fontFamily='monospace';t.innerHTML+=e+'<br />'}var modelIO=Object.freeze({toJSON:toJSON,sampleObj:sampleObj,sampleJSON:sampleJSON,printToPage:printToPage});class Animator{constructor(e,t = 60,n = !1){Object.assign(this,{model:e,rate:t,multiStep:n});this.reset()}setRate(e,t = !1){Object.assign(this,{rate:e,multiStep:t});this.resetTimes()}start(){if(!this.stopped)return;this.resetTimes();this.stopped=!1;this.animate()}stop(){this.stopped=!0;this.animHandle&&cancelAnimationFrame(this.animHandle);this.timeoutHandle&&clearTimeout(this.timeoutHandle);this.animHandle=this.timeoutHandle=null}resetTimes(){this.startMS=this.now();this.startTick=this.ticks;this.startDraw=this.draws}reset(){this.stop();this.ticks=this.draws=0}step(){this.model.tick();this.ticks++;this.model.step()}draw(){this.draws++;this.model.draw()}once(){this.step();this.draw()}now(){return performance.now()}ms(){return this.now()-this.startMS}ticksPerSec(){let e=this.ticks-this.startTick;return e===0?0:Math.round(e*1e3/this.ms())}drawsPerSec(){let e=this.draws-this.startDraw;return e===0?0:Math.round(e*1e3/this.ms())}get fps(){return Math.max(this.drawsPerSec(),this.ticksPerSec())}toString(){return`ticks: ${this.ticks}, draws: ${this.draws}, rate: ${this.rate} tps/dps: ${this.ticksPerSec()}/${this.drawsPerSec()}`}animateSteps(){this.step();this.stopped||(this.timeoutHandle=setTimeout(()=>this.animateSteps(),10))}animateDraws(){this.drawsPerSec()<this.rate&&(this.multiStep||this.step(),this.draw());this.stopped||(this.animHandle=requestAnimationFrame(()=>this.animateDraws()))}animate(){this.multiStep&&this.animateSteps();this.animateDraws()}}let Color={rgbaString(e,t,n,r = 255){r/=255;let o=r.toPrecision(2);return r===1?`rgb(${e},${t},${n})`:`rgba(${e},${t},${n},${o})`},hslString(e,t,n,r = 255){r/=255;let o=r.toPrecision(4);return r===1?`hsl(${e},${t}%,${n}%)`:`hsla(${e},${t}%,${n}%,${o})`},hexString(e,t,n,r = !0){if(r){let[r,o,i]=[e/17,t/17,n/17];if(util.isInteger(r)&&util.isInteger(o)&&util.isInteger(i)){return this.hexShortString(r,o,i)}}return`#${(16777216|(n|t<<8|e<<16)).toString(16).slice(-6)}`},hexShortString(e,t,n){if(e>15||t>15||n>15){throw Error(`hexShortString: one of ${[e,t,n]} > 15`)}return`#${e.toString(16)}${t.toString(16)}${n.toString(16)}`},triString(e,t,n,r = 255){return r===255?this.hexString(e,t,n,!0):this.rgbaString(e,t,n,r)},sharedCtx1x1:util.createCtx(1,1),stringToUint8s(e){this.sharedCtx1x1.clearRect(0,0,1,1);this.sharedCtx1x1.fillStyle=e;this.sharedCtx1x1.fillRect(0,0,1,1);return this.sharedCtx1x1.getImageData(0,0,1,1).data},color(e,t,n,r = 255){let o=new Uint8ClampedArray([e,t,n,r]);o.pixelArray=new Uint32Array(o.buffer);Object.setPrototypeOf(o,ColorProto);return o},isColor(e){return e&&e.constructor===Uint8ClampedArray&&e.pixelArray},toColor(e){if(this.isColor(e))return e;let t=this.color(0,0,0,0);if(util.isInteger(e))t.setPixel(e);else if(typeof e==='string')t.setCss(e);else if(Array.isArray(e)||util.isUintArray(e))t.setColor(...e);else if(util.isFloatArray(e))t.setWebgl(e);else{throw Error('toColor: invalid argument',e)}return t},randomColor(){let e=()=>util.randomInt(256);return this.color(e(),e(),e())}},ColorProto={__proto__:Uint8ClampedArray.prototype,setColor(e,t,n,r = 255){this.checkColorChange();this[0]=e;this[1]=t;this[2]=n;this[3]=r},set rgb(e){this.setColor(...e)},get rgb(){return this},setPixel(e){this.checkColorChange();this.pixelArray[0]=e},getPixel(){return this.pixelArray[0]},get pixel(){return this.getPixel()},set pixel(e){this.setPixel(e)},setCss(e){return this.setColor(...Color.stringToUint8s(e))},getCss(){this.string==null&&(this.string=Color.triString(...this));return this.string},get css(){return this.getCss()},set css(e){this.setCss(e)},setWebgl(e){this.setColor(e[0]*255,e[1]*255,e[2]*255,e.length===4?e[3]*255:void 0)},getWebgl(){if(this.floatArray==null){let e=[this[0]/255,this[1]/255,this[2]/255];this[3]!==255&&e.push(this[3]/255);this.floatArray=new Float32Array(e)}return this.floatArray},get webgl(){return this.getWebgl()},set webgl(e){this.setWebgl(e)},checkColorChange(){this.string=null;this.floatArray=null},equals(e){return this.getPixel()===e.getPixel()},toString(){return`[${Array.from(this).toString()}]`},rgbDistance(e,t,n){let[r,o,i]=this,a=Math.round((r+e)/2),[s,u,c]=[r-e,o-t,i-n],[l,d,f]=[s*s,u*u,c*c],h=((512+a)*l>>8)+4*d+((767-a)*f>>8);return h}},ColorMap={gradientImageData(e,t,n){t=t.map(e=>Array.isArray(e)?Color.rgbaString(...e):e);let r=util.createCtx(e,1);n||(n=util.aRamp(0,1,t.length));let o=r.createLinearGradient(0,0,e,0);util.repeat(t.length,e=>o.addColorStop(n[e],t[e]));r.fillStyle=o;r.fillRect(0,0,e,1);return util.ctxImageData(r).data},typedArraytoColors(e){let t=[];util.step(e.length,4,n=>t.push(Color.color(...e.subarray(n,n+4))));t.typedArray=e;return t},arraysToColors(e){let t=new Uint8ClampedArray(e.length*4);util.repeat(e.length,n=>{let r=e[n];r.length===3&&r.push(255);t.set(r,n*4)});return this.typedArraytoColors(t)},permuteArrays(e,t = e,n = e){let r=[];for(let o of n){for(let n of t)for(let t of e)r.push([t,n,o])}return r},permuteRGBColors(e,t = e,n = e){let r=e=>util.aIntRamp(0,255,e),o=[e,t,n].map(r);return this.permuteArrays(...o)},ColorMapProto:{__proto__:Array.prototype,createIndex(){this.index=[];util.repeat(this.length,e=>{let t=this[e].getPixel();this.index[t]=e;this.cssNames&&(this.index[this.cssNames[e]]=e)})},randomIndex(){return util.randomInt(this.length)},randomColor(){return this[this.randomIndex()]},indexOf(e){if(this.index)return this.index[e.getPixel()];for(let t=0;t<this.length;t++){if(e.equals(this[t]))return t}return void 0},scaleColor(e,t,n){e=util.clamp(e,t,n);let r=util.lerpScale(e,t,n),o=Math.round(util.lerp(0,this.length-1,r));return this[o]},webglArray(){return this.typedArray},toString(){return`${this.length} ${util.arraysToString(this)}`},rgbClosestIndex(e,t,n){let r=1/0,o=0;for(var i=0;i<this.length;i++){let a=this[i].rgbDistance(e,t,n);if(a<r){r=a;o=i;if(a===0)return o}}return o},rgbClosestColor(e,t,n){return this[this.rgbClosestIndex(e,t,n)]},cubeClosestIndex(e,t,n){let r=this.cube,o=r.map(e=>255/(e-1)),i=[e,t,n].map((e,t)=>Math.round(e/o[t])),[a,s,u]=i;return a+s*r[0]+u*r[0]*r[1]},cubeClosestColor(e,t,n){return this[this.cubeClosestIndex(e,t,n)]},closestIndex(e,t,n){return this.cube?this.cubeClosestIndex(e,t,n):this.rgbClosestIndex(e,t,n)},closestColor(e,t,n){return this[this.closestIndex(e,t,n)]}},basicColorMap(e){e=this.arraysToColors(e);Object.setPrototypeOf(e,this.ColorMapProto);return e},grayColorMap(e = 0,t = 255,n = t-e+1){let r=util.aIntRamp(e,t,n);return this.basicColorMap(r.map(e=>[e,e,e]))},rgbColorCube(e,t = e,n = e){let r=this.permuteRGBColors(e,t,n),o=this.basicColorMap(r);o.cube=[e,t,n];return o},rgbColorMap(e,t,n){let r=this.permuteArrays(e,t,n);return this.basicColorMap(r)},hslColorMap(e,t = [100],n = [50]){let r=this.permuteArrays(e,t,n),o=r.map(e=>Color.toColor(Color.hslString(...e)));return this.basicColorMap(o)},gradientColorMap(e,t,n){let r=this.gradientImageData(e,t,n),o=this.typedArraytoColors(r);Object.setPrototypeOf(o,this.ColorMapProto);return o},jetColors:[[0,0,127],[0,0,255],[0,127,255],[0,255,255],[127,255,127],[255,255,0],[255,127,0],[255,0,0],[127,0,0]],basicColorNames:'white silver gray black red maroon yellow orange olive lime green cyan teal blue navy magenta purple'.split(' '),cssColorMap(e,t = !1){let n=e.map(e=>Color.stringToUint8s(e)),r=this.basicColorMap(n);r.cssNames=e;t&&(e.forEach((e,t)=>{r[e]=r[t]}),r.cyan&&(r.aqua=r.cyan),r.magenta&&(r.fuchsia=r.magenta));return r},LazyMap(e,t){Object.defineProperty(this,e,{value:t,enumerable:!0});return t},get Gray(){return this.LazyMap('Gray',this.grayColorMap())},get LightGray(){return this.LazyMap('LightGray',this.grayColorMap(200))},get DarkGray(){return this.LazyMap('DarkGray',this.grayColorMap(0,100))},get Jet(){return this.LazyMap('Jet',this.gradientColorMap(256,this.jetColors))},get Rgb256(){return this.LazyMap('Rgb256',this.rgbColorCube(8,8,4))},get Rgb(){return this.LazyMap('Rgb',this.rgbColorCube(16))},get Basic16(){return this.LazyMap('Basic16',this.cssColorMap(this.basicColorNames,!0))}};class Link$1 extends Link{static defaultVariables(){return{typedColor:null}}constructor(){super();Object.assign(this,Link$1.defaultVariables())}setColor(e){let t=Color.toColor(e),n=this.links.renderer.fixedColor;n&&!t.equals(n)?util.warn(`links.setColor: fixedColor != color ${n.toString()}`):(this.typedColor=t)}getColor(){return this.typedColor}set color(e){this.setColor(e)}get color(){return this.getColor()}}class Links$1 extends Links{create(e,t,n){let r=super.create(e,t,n);r.forEach(e=>{e.color||(e.color=this.model.randomColor())});return r}test(){console.log(this.map(e=>e.id))}}class Patches$1 extends Patches{constructor(e,t,n){super(e,t,n);if(this.isBreedSet())return;this.setPixels()}setPixels(){let{numX:e,numY:t}=this.model.world;this.pixels={ctx:util.createCtx(e,t)};this.setImageData()}setImageData(){let e=this.pixels;e.imageData=util.ctxImageData(e.ctx);e.data8=e.imageData.data;e.data=new Uint32Array(e.data8.buffer)}setDefault(e,t){e==='color'?(this.ask(e=>{e.setColor(t)}),util.logOnce('patches.setDefault(color, value): color default not supported. Clearing to value')):super.setDefault(e,t)}installPixels(){let e=this.pixels;e.ctx.putImageData(e.imageData,0,0);return e}importColors(e){util.imagePromise(e).then(e=>this.installColors(e))}installColors(e){util.fillCtxWithImage(this.pixels.ctx,e);this.setImageData()}scaleColors(e,t,n,r){this.ask(o=>{o.setColor(e.scaleColor(o[t],n,r))})}test(){console.log(this.map(e=>e.id))}}class Patch$1 extends Patch{setColor(e){this.patches.pixels.data[this.id]=Color.toColor(e).getPixel()}getColor(e = null){let t=this.patches.pixels.data[this.id];if(e){e.pixel=t;return e}return Color.toColor(t)}get color(){return this.getColor()}set color(e){this.setColor(e)}}class Turtles$1 extends Turtles{create(e = 1,t = e=>{}){return util.repeat(e,(e,n)=>{let r=this.addAgent();r.theta=util.randomFloat(Math.PI*2);t(r);r.color||(r.color=this.model.randomColor());n.push(r)})}test(){console.log(this.map(e=>e.id))}}class Turtle$1 extends Turtle{static defaultVariables(){return{size:1,sprite:null,typedColor:null,typedStrokeColor:null,shapeFcn:'default'}}constructor(){super();Object.assign(this,Turtle$1.defaultVariables())}setSprite(e = null){if(e)this.sprite=e;else{let{shape:e,color:t,strokeColor:n}=this,r=e.slice(-1)==='2';e=e||'default';t=t||this.model.randomColor();n=r?n||this.model.randomColor():null;this.sprite=this.model.spriteSheet.newSprite(e,t,n)}return this.sprite}checkSprite(){if(!this.turtles.renderer.useSprites)return;if(this.turtles.settingDefault(this)){let{shape:e,typedColor: t,typedStrokeColor: n}=this,r=e.slice(-1)==='2',o=e&&t&&(!r||n);o&&(this.sprite=this.model.spriteSheet.newSprite(e,t,n))}else this.sprite=null}setSize(e){this.size=e}setColor(e){let t=Color.toColor(e),n=this.turtles.renderer.fixedColor;n?util.warn(`turtle.setColor: fixedColor ${n.toString()}`):(this.typedColor=t);this.checkSprite()}getColor(){return this.sprite?this.sprite.color:this.typedColor}set color(e){this.setColor(e)}get color(){return this.getColor()}setStrokeColor(e){let t=Color.toColor(e),n=this.turtles.renderer.fixedColor;n?util.warn(`turtle.setStrokeColor: fixedColor ${n.toString()}`):(this.typedStrokeColor=t);this.checkSprite()}getStrokeColor(){return this.sprite?this.sprite.strokeColor:this.typedStrokeColor}set strokdColor(e){this.setStrokeColor(e)}get strokdColor(){return this.getStrokeColor()}setShape(e){let t=this.turtles.renderer.fixedShape;t?util.warn(`turtle.setShape: fixedShape ${t}`):(this.shapeFcn=e);this.checkSprite()}getShape(){return this.sprite?this.sprite.src:this.shapeFcn}set shape(e){this.setShape(e)}get shape(){return this.getShape()}}class SpriteSheet{constructor(e = 64,t = 16,n = !0){Object.assign(this,{spriteSize:e,cols:t,usePowerOf2:n});this.rows=1;this.nextCol=0;this.nextRow=0;this.sprites={};this.paths=Object.assign({},paths);n&&this.checkPowerOf2();this.ctx=util.createCtx(this.width,this.height);this.texture=null}get width(){return this.spriteSize*this.cols}get height(){return this.spriteSize*this.rows}get nextX(){return this.spriteSize*this.nextCol}get nextY(){return this.spriteSize*this.nextRow}get id(){return Object.keys(this.sprites).length}clear(){Object.assign(this.ctx.canvas,{width:this.width,height:this.spriteSize})}newSprite(e,t,n){let r=util.isImageable(e);r&&!t&&(t='red');t&&(t=Color.toColor(t));n&&(n=Color.toColor(n));let o=this.spriteName(e,t,n);if(this.sprites[o])return this.sprites[o];let i=r?this.addImage(e):this.addDrawing(e,t,n);Object.assign(i,{src:e,color:t,strokeColor:n});this.sprites[o]=i;return i}installDrawFcn(e,t = e.name){this.paths[t]=e}spriteName(e,t,n){let r;if(util.isImageable(e))r=e.src,r=r.replace(/^.*\//,''),r=r.replace(/\..*/,'.img');else{r=e.name||e;r.endsWith('2')||(n=null);let o=t.css,i=n?n.css:'';r=`${r}${o}${i}`}return r}addImage(e){this.checkSheetSize();let[t,n,r]=[this.nextX,this.nextY,this.spriteSize];this.ctx.drawImage(e,t,n,r,r);let o=this.id,{nextRow: i,nextCol: a}=this,s={id:o,x:t,y:n,row:i,col:a,size:r,sheet:this};s.uvs=this.getUVs(s);this.incrementRowCol();this.texture&&(this.texture.needsUpdate=!0);return s}addDrawing(e,t,n,r = !0){let o=this.createFcnCanvas(e,t,n,r);return this.addImage(o)}oneOf(){return util.oneValOf(this.sprites)}checkSheetSize(){this.nextRow===this.rows&&(this.rows=this.usePowerOf2?this.rows*2:this.rows+1,util.resizeCtx(this.ctx,this.width,this.height),util.forEach(this.sprites,e=>{e.uvs=this.getUVs(e)}))}incrementRowCol(){this.nextCol+=1;if(this.nextCol<this.cols)return;this.nextCol=0;this.nextRow+=1}createFcnCanvas(e,t,n,r = !0){let o=util.createCtx(this.spriteSize,this.spriteSize);o.fillStyle=t.css||t;n&&(o.strokeStyle=n.css||n);r&&(o.scale(this.spriteSize/2,this.spriteSize/2),o.translate(1,1),o.beginPath());util.isString(e)?this.paths[e](o):e(o);r&&(o.closePath(),o.fill());let i=e.name||e;o.canvas.src=`${i}${t}`;return o.canvas}getUVs(e){let{row:t,col:n}=e,{rows:r,cols:o}=this,i=n/o,a=(r-(t+1))/r,s=(n+1)/o,u=(r-t)/r;return[i,a,s,a,s,u,i,u]}checkPowerOf2(){let{width:e,height:t}=this;if(!(util.isPowerOf2(e)&&util.isPowerOf2(t))){throw Error(`SpriteSheet non power of 2: ${e}x${t}`)}}}let paths={poly(e,t){t.forEach((t,n)=>{n===0?e.moveTo(t[0],t[1]):e.lineTo(t[0],t[1])})},default(e){this.dart(e)},arrow(e){this.poly(e,[[1,0],[0,1],[0,.4],[-1,.4],[-1,-.4],[0,-.4],[0,-1]])},bug(e){e.strokeStyle=e.fillStyle;this.bug2(e)},bug2(e){e.lineWidth=.1;this.poly(e,[[.8,.45],[.4,0],[.8,-.45]]);e.stroke();e.beginPath();e.arc(.24,0,.26,0,2*Math.PI);e.arc(-.1,0,.26,0,2*Math.PI);e.arc(-.54,0,.4,0,2*Math.PI)},circle(e){e.arc(0,0,1,0,2*Math.PI)},dart(e){this.poly(e,[[1,0],[-1,.8],[-.5,0],[-1,-.8]])},frame(e){let t=.4;e.fillRect(-1,-1,2,2);e.fill();e.clearRect(-1+t,-1+t,2-2*t,2-2*t)},frame2(e){let t=.4;e.fillRect(-1,-1,2,2);e.fill();e.fillStyle=e.strokeStyle;e.fillRect(-1+t,-1+t,2-2*t,2-2*t)},person(e){e.strokeStyle=e.fillStyle;this.person2(e)},person2(e){this.poly(e,[[.3,-.4],[.6,0],[.25,.2],[.25,-.1],[.2,.3],[.5,1],[.1,1],[0,.5],[-.1,1],[-.5,1],[-.2,.3],[-.25,-.1],[-.25,.2],[-.6,0],[-.3,-.4]]);e.closePath();e.fill();e.beginPath();e.fillStyle=e.strokeStyle;e.arc(0,-.7,.3,0,2*Math.PI)},ring(e){let[t,n]=[1,.6];e.arc(0,0,t,0,2*Math.PI,!1);e.lineTo(n,0);e.arc(0,0,n,0,2*Math.PI,!0)},ring2(e){let[t,n]=[1,.6];e.arc(0,0,t,0,2*Math.PI);e.closePath();e.fill();e.beginPath();e.fillStyle=e.strokeStyle;e.arc(0,0,n,0,2*Math.PI)},square(e){e.fillRect(-1,-1,2,2)},triangle(e){this.poly(e,[[1,0],[-1,-.8],[-1,.8]])}};class BaseMesh{constructor(e,t = this.constructor.options()){let{scene:n,model:r}=e;Object.assign(this,{scene:n,model:r,view:e,options:t});this.mesh=null;this.name=this.constructor.name;this.fixedColor=t.color;this.fixedSize=t.pointSize;this.fixedShape=this.name==='PatchesMesh'?'Patch':this.name==='PointsMesh'?'Point':this.name==='LinksMesh'?'Link':void 0;this.useSprites=this.name.match(/sprites/i)!=null}dispose(){if(!this.mesh)return;this.mesh.parent!==this.scene&&console.log('mesh parent not scene');this.mesh.parent.remove(this.mesh);this.mesh.geometry.dispose();this.mesh.material.dispose();this.mesh.material.map&&this.mesh.material.map.dispose()}init(){throw Error('init is abstract, must be overriden')}update(){throw Error('update is abstract, must be overriden')}createQuad(e,t = 0){let n=[-e,-e,t,e,-e,t,e,e,t,-e,e,t],r=[0,1,2,0,2,3];return{vertices:n,indices:r}}get spriteSheetTexture(){if(!this.model.spriteSheet.texture){let e=new THREE.CanvasTexture(this.model.spriteSheet.ctx.canvas);this.model.spriteSheet.texture=e}return this.model.spriteSheet.texture}}class CanvasMesh extends BaseMesh{init(e){this.mesh&&this.dispose();let{textureOptions:t,z:n}=this.options;Object.assign(this,{canvas:e,z:n,textureOptions:t});let{width:r,height:o,numX:i,numY:a,centerX:s,centerY:u}=this.model.world,c=1,l=new THREE.CanvasTexture(e);for(let e in t)l[e]=THREE[t[e]];let d=new THREE.PlaneGeometry(r,o,i,a);d.translate(s*c,u*c,0);let f=new THREE.MeshBasicMaterial({map:l,shading:THREE.FlatShading,side:THREE.DoubleSide,transparent:!0});this.mesh=new THREE.Mesh(d,f);this.mesh.position.z=n;this.scene.add(this.mesh)}update(){this.mesh.material.map.needsUpdate=!0}}class PatchesMesh extends CanvasMesh{static options(){return{textureOptions:{minFilter:'NearestFilter',magFilter:'NearestFilter'},z:1}}init(e){super.init(e.pixels.ctx.canvas)}update(e){e.installPixels();super.update()}}class QuadSpritesMesh extends BaseMesh{static options(){return{z:2}}constructor(e,t){super(e,t);this.unitQuad=this.createQuad(.5,0)}init(){this.mesh&&this.dispose();let e=this.spriteSheetTexture,t=new Float32Array,n=new Float32Array,r=new Uint32Array,o=new THREE.BufferGeometry;o.addAttribute('position',new THREE.BufferAttribute(t,3));o.addAttribute('uv',new THREE.BufferAttribute(n,2));o.setIndex(new THREE.BufferAttribute(r,1));let i=new THREE.MeshBasicMaterial({map:e,alphaTest:.5,side:THREE.DoubleSide});this.mesh=new THREE.Mesh(o,i);this.mesh.position.z=this.options.z;this.scene.add(this.mesh)}update(e){let t=this.mesh,{vertices:n,indices:r}=this.unitQuad,o=1,i=t.geometry.getAttribute('position'),a=t.geometry.getAttribute('uv'),s=t.geometry.getIndex(),u=new Float32Array(n.length*e.length),c=[],l=[];for(let t=0;t<e.length;t++){let i=e[t];i.sprite||i.setSprite();let a=i.size,s=i.theta,d=Math.cos(s),f=Math.sin(s),h=t*n.length;for(let e=0;e<n.length;e=e3){let t=n[e],r=n[e+1],s=i.x,c=i.y;u[e+h]=(a*(t*d-r*f)+s)*o;u[e+h+1]=(a*(t*f+r*d)+c)*o;u[e+h+2]=i.z*o}l.push(...r.map(e=>e+t*4));c.push(...i.sprite.uvs)}i.setArray(u);i.needsUpdate=!0;a.setArray(new Float32Array(c));a.needsUpdate=!0;s.setArray(new Uint32Array(l));s.needsUpdate=!0}}class PointsMesh extends BaseMesh{static options(){return{pointSize:1,color:null,z:2}}init(){this.mesh&&this.dispose();let e=this.options.pointSize,t=this.options.color?new THREE.Color(...this.options.color):null,n=new THREE.BufferGeometry;n.addAttribute('position',new THREE.BufferAttribute(new Float32Array,3));t==null&&n.addAttribute('color',new THREE.BufferAttribute(new Float32Array,3));let r=t?new THREE.PointsMaterial({size:e,color:t}):new THREE.PointsMaterial({size:e,vertexColors:THREE.VertexColors});this.mesh=new THREE.Points(n,r);this.mesh.position.z=this.options.z;this.scene.add(this.mesh)}update(e){let t=this.mesh.geometry.getAttribute('position'),n=this.mesh.geometry.getAttribute('color'),r=[],o=n==null?null:[],i=1;for(let t=0;t<e.length;t++){let{x:n,y:a,z:s,color:u}=e[t];r.push(n*i,a*i,s*i);o!=null&&o.push(...u.webgl)}t.setArray(new Float32Array(r));t.needsUpdate=!0;o&&(n.setArray(new Float32Array(o)),n.needsUpdate=!0)}}class LinksMesh extends BaseMesh{static options(){return{color:null,z:1.5}}init(){this.mesh&&this.dispose();let e=this.options.color?new THREE.Color(...this.options.color):null,t=new THREE.BufferGeometry;t.addAttribute('position',new THREE.BufferAttribute(new Float32Array,3));e==null&&t.addAttribute('color',new THREE.BufferAttribute(new Float32Array,3));let n=e?new THREE.LineBasicMaterial({color:e}):new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});this.mesh=new THREE.LineSegments(t,n);this.mesh.position.z=this.options.z;this.scene.add(this.mesh)}update(e){let t=[],n=this.options.color?null:[];for(let r=0;r<e.length;r++){let{end0:o,end1:i,color:a}=e[r],{x: s,y: u,z: c}=o,{x: l,y: d,z: f}=i,h=1;t.push(s*h,u*h,c*h,l*h,d*h,f*h);n&&n.push(...a.webgl,...a.webgl)}let r=this.mesh.geometry.getAttribute('position');r.setArray(new Float32Array(t));r.needsUpdate=!0;if(n){let e=this.mesh.geometry.getAttribute('color');e.setArray(new Float32Array(n));e.needsUpdate=!0}}}var ThreeMeshes={BaseMesh,CanvasMesh,PatchesMesh,QuadSpritesMesh,PointsMesh,LinksMesh};class ThreeView{static defaultOptions(e = !0,t = !0){let n={Renderer:ThreeView,orthoView:!1,clearColor:0,useAxes:e,useGrid:e,useControls:e,spriteSize:64,patches:{meshClass:'PatchesMesh'},turtles:{meshClass:'QuadSpritesMesh'},links:{meshClass:'LinksMesh'}};util.forEach(n,(e,t)=>{if(e.meshClass){let t=ThreeMeshes[e.meshClass],n=t.options();e.options=n}});return n}static printMeshOptions(){let e={};for(let t in ThreeMeshes){let n=ThreeMeshes[t].options;n&&(e[t]={options:ThreeMeshes[t].options()})}let t=util.objectToString(e);console.log(t)}constructor(e,t = {}){this.model=e;Object.assign(this,ThreeMeshes.defaultOptions);Object.assign(this,t);if(this.Renderer!==ThreeView){throw Error('ThreeView ctor: Renderer not ThreeView',this.renderer)}this.initThree();this.initThreeHelpers()}initThree(){let{clientWidth:e,clientHeight:t}=this.model.div,{orthoView:n,clearColor:r}=this,{width:o,height:i}=this.model.world,[a,s]=[o/2,i/2],u=new THREE.OrthographicCamera(-a,a,s,-s,1,20*o);u.position.set(0,0,10*o);u.up.set(0,0,1);let c=new THREE.PerspectiveCamera(45,e/t,1,1e4);c.position.set(o,-o,o);c.up.set(0,0,1);let l=new THREE.Scene,d=n?u:c,f=new THREE.WebGLRenderer;f.setPixelRatio(window.devicePixelRatio);f.setSize(e,t);f.setClearColor(r);this.model.div.appendChild(f.domElement);window.addEventListener('resize',()=>{this.resize()});Object.assign(this,{scene:l,camera:d,renderer:f,orthographicCam:u,perspectiveCam:c})}resize(){let{clientWidth:e,clientHeight:t}=this.model.div,{width:n,height:r}=this.model.world;if(this.orthoView){let o=Math.min(e/n,t/r);this.renderer.setSize(o*n,o*r)}else this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}toggleCamera(){this.orthoView=!this.orthoView;this.orthoView?(this.camera=this.orthographicCam):(this.camera=this.perspectiveCam);this.resize()}snapshot(e = !0){let{scene:t,renderer:n,model:r}=this,o=e&&this.camera===this.perspectiveCam;o&&(this.toggleCamera(),r.draw(!0));n.render(t,this.camera);let i=n.domElement.toDataURL();o&&this.toggleCamera();return i}initThreeHelpers(){let{scene:e,renderer:t,camera:n}=this,{useAxes:r,useGrid:o,useControls:i}=this,{width:a}=this.model.world,s={};r&&(s.axes=new THREE.AxisHelper(1.5*a/2),e.add(s.axes));o&&(s.grid=new THREE.GridHelper(1.25*a,10),s.grid.rotation.x=THREE.Math.degToRad(90),e.add(s.grid));i&&(s.controls=new THREE.OrbitControls(n,t.domElement));Object.assign(this,s)}}class Model$1 extends Model{static defaultWorld(e,t){return super.defaultWorld(e,t)}static defaultRenderer(){return ThreeView.defaultOptions()}static printDefaultViewOptions(){ThreeView.printMeshOptions()}constructor(e = document.body,t = Model$1.defaultWorld(),n = Model$1.defaultRenderer()){super(t);this.div=util.isString(e)?document.getElementById(e):e;this.renderOptions=n;this.anim=new Animator(this);this.colorMap=ColorMap.Basic16;this.spriteSheet=new SpriteSheet(n.spriteSize);this.view=new n.Renderer(this,n);this.meshes={};util.forEach(n,(e,t)=>{if(e.meshClass){let n=ThreeMeshes[e.meshClass],r=n.options();Object.assign(r,e.options);r.color&&(r.color=Color.toColor(new Float32Array(r.color)));this.meshes[t]=new ThreeMeshes[e.meshClass](this.view,r)}});this.resetView()}initAgentRenderer(e){let t=this.meshes[e.name];e.renderer=t;t.fixedColor&&e.setDefault('color',t.fixedColor);t.fixedShape&&e.setDefault('shape',t.fixedShape);t.init(e)}resetModel(){this.ticks=0;this.world=new World(this.worldOptions);this.initAgentSet('patches',Patches$1,Patch$1);this.initAgentSet('turtles',Turtles$1,Turtle$1);this.initAgentSet('links',Links$1,Link$1)}resetView(){this.anim.reset();this.refreshLinks=this.refreshTurtles=this.refreshPatches=!0;this.initAgentRenderer(this.patches);this.initAgentRenderer(this.turtles);this.initAgentRenderer(this.links)}reset(){this.resetModel();this.resetView()}randomColor(){return this.colorMap.randomColor()}start(){this.anim.start();return this}stop(){this.anim.stop()}once(){this.stop();this.anim.once()}draw(e = this.anim.stopped||this.anim.draws===1){this.div&&((e||this.refreshPatches)&&(this.patches.length>0&&this.patches.renderer.update(this.patches)),(e||this.refreshTurtles)&&(this.turtles.length>0&&this.turtles.renderer.update(this.turtles)),(e||this.refreshLinks)&&(this.links.length>0&&this.links.renderer.update(this.links)),this.view.renderer.render(this.view.scene,this.view.camera))}}class Mouse{constructor(e,t,n = null){Object.assign(this,{element:e,world:t,callback:n});this.mouseDown=e=>this.handleMouseDown(e);this.mouseUp=e=>this.handleMouseUp(e);this.mouseMove=e=>this.handleMouseMove(e)}resetParams(){this.xCor=this.yCor=NaN;this.moved=this.down=!1}start(){this.element.addEventListener('mousedown',this.mouseDown);document.body.addEventListener('mouseup',this.mouseUp);this.element.addEventListener('mousemove',this.mouseMove);this.resetParams();return this}stop(){this.element.removeEventListener('mousedown',this.mouseDown);document.body.removeEventListener('mouseup',this.mouseUp);this.element.removeEventListener('mousemove',this.mouseMove);this.resetParams();return this}generalHandler(e,t,n){this.down=t;this.moved=n;this.setXY(e);this.callback!=null&&this.callback(e)}handleMouseDown(e){this.action='down';this.generalHandler(e,!0,!1)}handleMouseUp(e){this.action='up';this.generalHandler(e,!1,!1)}handleMouseMove(e){this.action=this.down?'drag':'move';this.generalHandler(e,this.down,!0)}setXY(e){let t=this.element.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top;Object.assign(this,this.pixelXYtoPatchXY(n,r))}patchSize(){let{numX:e,numY:t}=this.world,{clientWidth: n,clientHeight: r}=this.element,o=n/e,i=r/t;if(o!==i){throw Error(`Mouse patchSize: xSize, ySize differ ${o}, ${i}`)}return o}pixelXYtoPatchXY(e,t){let n=this.patchSize(),{minXcor:r,maxYcor:o}=this.world;return{x:r+e/n,y:o-t/n}}}export { AgentArray, AgentSet, Animator, Color, ColorMap, DataSet, Link$1 as Link, Links$1 as Links, Model$1 as Model, Mouse, Patch$1 as Patch, Patches$1 as Patches, RGBDataSet, SpriteSheet, ThreeView, ThreeMeshes, Turtle$1 as Turtle, Turtles$1 as Turtles, World, util }
